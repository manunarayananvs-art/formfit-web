<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FormFit - Crop & Compress</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        .container { max-width: 600px; }
        
        /* Drop Zone */
        .drop-zone { border: 2px dashed #0d6efd; border-radius: 10px; padding: 40px; text-align: center; background: white; cursor: pointer; transition: 0.3s; }
        .drop-zone:hover { background-color: #e9ecef; }
        
        /* Crop Area */
        .crop-container { 
            height: 400px; 
            background: #333; 
            margin-bottom: 20px; 
            border-radius: 5px; 
            overflow: hidden;
        }
        img { max-width: 100%; }

        /* Preview Area */
        .preview-container { 
            position: relative; 
            min-height: 200px; 
            background: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            overflow: hidden;
        }
        .preview-img { max-width: 100%; display: block; }
        
        .badge-safe { background-color: #d1e7dd; color: #0f5132; padding: 5px 10px; border-radius: 20px; font-size: 0.8em; }
        .compare-btn { user-select: none; font-weight: bold; }
    </style>
</head>
<body>

<div class="container mt-4">
    <div class="text-center mb-4">
        <h1>üñºÔ∏è FormFit</h1>
        <p class="text-muted">Crop & Compress securely.</p>
        <span class="badge-safe">üîí Local Processing</span>
    </div>

    <div id="uploadStep" class="drop-zone mb-4" onclick="document.getElementById('imageInput').click()">
        <h4>Tap to Select Image</h4>
        <p class="text-muted small">Supports JPG, PNG, WEBP</p>
        <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
    </div>

    <div id="cropStep" class="card p-3 shadow-sm" style="display: none;">
        <h5 class="mb-3">‚úÇÔ∏è Crop Image</h5>
        <div class="crop-container">
            <img id="cropImage" src="">
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-secondary flex-grow-1" onclick="resetApp()">Cancel</button>
            <button class="btn btn-primary flex-grow-1" onclick="confirmCrop()">Done & Compress</button>
        </div>
    </div>

    <div id="resultStep" class="card p-3 shadow-sm" style="display: none;">
        
        <div class="preview-container mb-3">
            <img id="displayImage" class="preview-img" src="" alt="Result">
        </div>

        <div class="row mb-2">
            <div class="col-6 text-center">
                <h6>Original (Cropped)</h6>
                <p id="originalInfo" class="small text-danger"></p>
            </div>
            <div class="col-6 text-center">
                <h6>Compressed</h6>
                <p id="compressedSize" class="small text-success">Processing...</p>
            </div>
        </div>

        <label class="form-label fw-bold">Target Size (KB)</label>
        <div class="d-flex gap-2 mb-3">
            <button class="btn btn-outline-secondary btn-sm" onclick="updateTarget(20)">20KB</button>
            <button class="btn btn-outline-secondary btn-sm" onclick="updateTarget(50)">50KB</button>
            <button class="btn btn-outline-secondary btn-sm" onclick="updateTarget(100)">100KB</button>
        </div>
        
        <input type="range" class="form-range" id="sizeSlider" min="10" max="500" step="10" value="50" oninput="updateSliderVal(this.value)">
        <p class="text-center small">Target: <span id="sliderValue">50</span> KB</p>

        <div class="d-flex gap-2 flex-column">
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary w-50" onclick="reCompress()">Retry</button>
                <button id="compareBtn" class="btn btn-warning w-50 compare-btn" 
                    onmousedown="showOriginal()" onmouseup="showCompressed()" 
                    onmouseleave="showCompressed()"
                    ontouchstart="showOriginal()" ontouchend="showCompressed()">
                    Hold to Compare
                </button>
            </div>
            
            <a id="downloadLink" href="#" download="formfit_compressed.jpg" class="btn btn-success w-100 mt-2">‚¨áÔ∏è Download Image</a>
            <button class="btn btn-link text-muted btn-sm mt-1" onclick="resetApp()">Start Over</button>
        </div>
        
        <p id="qualityInfo" class="text-center small text-muted mt-2 mb-0"></p>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
    let cropper = null;
    let croppedCanvas = null;   // The high-res cropped image (Canvas)
    let compressedURL = null;   // The final compressed blob URL
    let originalURL = null;     // The cropped image URL (for comparison)

    // --- STEP 1: Upload & Init Cropper ---
    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const url = URL.createObjectURL(file);
        const imageElement = document.getElementById('cropImage');
        imageElement.src = url;

        // Switch UI
        document.getElementById('uploadStep').style.display = 'none';
        document.getElementById('cropStep').style.display = 'block';

        // Destroy old cropper if exists
        if (cropper) cropper.destroy();

        // Init Cropper
        cropper = new Cropper(imageElement, {
            viewMode: 1,
            autoCropArea: 1,
        });
    }

    // --- STEP 2: Confirm Crop ---
    function confirmCrop() {
        // Get the cropped canvas
        croppedCanvas = cropper.getCroppedCanvas();
        if (!croppedCanvas) return;

        // Create a URL for the "Original" (Cropped) version for comparison
        croppedCanvas.toBlob((blob) => {
            if (originalURL) URL.revokeObjectURL(originalURL);
            originalURL = URL.createObjectURL(blob);
            document.getElementById('originalInfo').innerText = "~" + (blob.size/1024).toFixed(0) + " KB";
        });

        // Switch UI
        document.getElementById('cropStep').style.display = 'none';
        document.getElementById('resultStep').style.display = 'block';

        // Trigger Compression
        reCompress();
    }

    // --- STEP 3: Compression Logic ---
    function updateTarget(val) {
        document.getElementById('sizeSlider').value = val;
        updateSliderVal(val);
        reCompress();
    }

    function updateSliderVal(val) {
        document.getElementById('sliderValue').innerText = val;
    }

    async function reCompress() {
        if (!croppedCanvas) return;
        
        const targetKB = document.getElementById('sizeSlider').value;
        const targetBytes = targetKB * 1024;

        // UI Feedback
        document.getElementById('compressedSize').innerText = "Compressing...";
        document.getElementById('displayImage').style.opacity = '0.5';

        try {
            // Pass the CROPPED canvas to the smart compressor
            const compressedBlob = await compressRecursive(croppedCanvas, targetBytes);
            
            // Handle Result
            if (compressedURL) URL.revokeObjectURL(compressedURL);
            compressedURL = URL.createObjectURL(compressedBlob);

            // Update UI
            document.getElementById('displayImage').src = compressedURL;
            document.getElementById('displayImage').style.opacity = '1';
            document.getElementById('compressedSize').innerText = (compressedBlob.size / 1024).toFixed(2) + " KB";
            
            // Tech stats
            const qPercent = (compressedBlob.quality * 100).toFixed(0);
            document.getElementById('qualityInfo').innerText = 
                `Quality: ${qPercent}% | Res: ${compressedBlob.width}x${compressedBlob.height}`;

            document.getElementById('downloadLink').href = compressedURL;

        } catch (e) {
            console.error(e);
            alert("Compression failed");
        }
    }

    // --- RECURSIVE SMART ENGINE ---
    // Note: We accept a 'sourceCanvas' here, which is our cropped image
    async function compressRecursive(sourceCanvas, targetSize) {
        let min = 0.0;
        let max = 1.0;
        let bestBlob = null;
        let bestQuality = 0;

        // 1. Binary Search for Quality
        for (let i = 0; i < 8; i++) {
            const mid = (min + max) / 2;
            const blob = await getCanvasBlob(sourceCanvas, mid);
            
            if (blob.size <= targetSize) {
                bestBlob = blob;
                bestQuality = mid;
                min = mid; 
            } else {
                max = mid; 
            }
        }

        // 2. Decision: Accept if quality is decent (>15%) OR image is tiny
        if ((bestBlob && bestQuality > 0.15) || sourceCanvas.width < 400) {
            bestBlob.quality = bestQuality;
            bestBlob.width = sourceCanvas.width;
            bestBlob.height = sourceCanvas.height;
            return bestBlob;
        }

        // 3. Fallback: Resize (Scale Down)
        const newCanvas = document.createElement('canvas');
        const scaleFactor = 0.75;
        newCanvas.width = Math.floor(sourceCanvas.width * scaleFactor);
        newCanvas.height = Math.floor(sourceCanvas.height * scaleFactor);
        const ctx = newCanvas.getContext('2d');
        // Draw the *source* canvas onto the smaller canvas
        ctx.drawImage(sourceCanvas, 0, 0, newCanvas.width, newCanvas.height);

        // Recursive call with smaller canvas
        return await compressRecursive(newCanvas, targetSize);
    }

    function getCanvasBlob(canvas, quality) {
        return new Promise((resolve) => {
            canvas.toBlob((blob) => {
                resolve(blob);
            }, 'image/jpeg', quality);
        });
    }

    // --- UTILS ---
    function showOriginal() {
        if(originalURL) document.getElementById('displayImage').src = originalURL;
    }
    function showCompressed() {
        if(compressedURL) document.getElementById('displayImage').src = compressedURL;
    }
    function resetApp() {
        location.reload(); 
    }
</script>

</body>
</html>
