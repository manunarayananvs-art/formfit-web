<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FormFit Pro - History Edition</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; padding-bottom: 80px; }
        .container { max-width: 600px; }
        
        /* Drop Zone */
        .drop-zone { border: 2px dashed #0d6efd; border-radius: 12px; padding: 40px 20px; text-align: center; background: white; cursor: pointer; transition: 0.3s; }
        .drop-zone:hover { background-color: #eef5ff; border-color: #0b5ed7; }
        
        /* Crop & Preview */
        .crop-wrapper { height: 400px; background: #333; margin-bottom: 15px; border-radius: 8px; overflow: hidden; }
        img { max-width: 100%; }
        .preview-container { min-height: 200px; background: #e9ecef; display: flex; align-items: center; justify-content: center; border-radius: 8px; border: 1px solid #dee2e6; }
        
        /* History Section */
        .history-item { background: white; border-radius: 8px; padding: 10px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 10px; }
        .history-thumb { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }
        .history-meta { flex-grow: 1; font-size: 0.9em; }
        .badge-safe { background-color: #d1e7dd; color: #0f5132; padding: 6px 12px; border-radius: 20px; font-size: 0.85em; }
    </style>
</head>
<body>

<div class="container mt-5">
    
    <div class="text-center mb-4">
        <h1 class="fw-bold">üñºÔ∏è FormFit <span class="text-primary">History</span></h1>
        <p class="text-muted mb-2">Compress, Download, and Resume later.</p>
        <span class="badge-safe">üîí Local Storage Active</span>
    </div>

    <div id="uploadStep" class="drop-zone shadow-sm" onclick="document.getElementById('imageInput').click()">
        <div class="mb-3" style="font-size: 3rem;">üìÇ</div>
        <h4>Tap to Upload Document</h4>
        <p class="text-muted small">Supports JPG, PNG, WEBP</p>
        <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
    </div>

    <div id="cropStep" class="card p-3 shadow-sm border-0" style="display: none;">
        <label class="form-label fw-bold">Use Case Preset</label>
        <select id="presetSelect" class="form-select mb-3" onchange="applyPreset(this.value)">
            <option value="passport_in">üáÆüá≥ Indian Passport (50KB)</option>
            <option value="passport_us">üá∫üá∏ US Visa (240KB)</option>
            <option value="signature">‚úçÔ∏è Signature (20KB)</option>
            <option value="custom">üõ†Ô∏è Custom</option>
        </select>

        <div class="crop-wrapper">
            <img id="cropImage" src="">
        </div>

        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary flex-grow-1" onclick="resetApp()">Cancel</button>
            <button class="btn btn-primary flex-grow-1" onclick="confirmCrop()">‚úÖ Compress & Save</button>
        </div>
    </div>

    <div id="resultStep" class="card p-3 shadow-sm border-0" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Success!</h5>
            <span class="badge bg-success" id="finalSizeBadge">-- KB</span>
        </div>

        <div class="preview-container mb-3">
            <img id="displayImage" style="max-width:100%; max-height:300px;" src="">
        </div>

        <a id="downloadLink" href="#" class="btn btn-success w-100 py-2 shadow-sm mb-2">‚¨áÔ∏è Download Image</a>
        <button class="btn btn-link text-muted btn-sm w-100" onclick="resetApp()">Process Another Image</button>
    </div>

    <div class="mt-5">
        <h6 class="text-muted text-uppercase fw-bold small mb-3">üíæ Recent Local Files</h6>
        <div id="historyList">
            <p class="text-center text-muted small">No saved files yet.</p>
        </div>
        <button onclick="clearHistory()" class="btn btn-sm btn-outline-danger w-100 mt-2" id="clearBtn" style="display:none">Clear All History</button>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
    // --- DATABASE (IndexedDB) MODULE ---
    const DB_NAME = 'FormFitDB';
    const DB_VERSION = 1;
    const STORE_NAME = 'files';

    const db = {
        init: () => {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(DB_NAME, DB_VERSION);
                req.onupgradeneeded = (e) => {
                    if (!e.target.result.objectStoreNames.contains(STORE_NAME)) {
                        e.target.result.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        },
        save: async (fileData) => {
            const dbRef = await db.init();
            const tx = dbRef.transaction(STORE_NAME, 'readwrite');
            tx.objectStore(STORE_NAME).put(fileData);
            return tx.complete;
        },
        getAll: async () => {
            const dbRef = await db.init();
            return new Promise((resolve) => {
                const tx = dbRef.transaction(STORE_NAME, 'readonly');
                const req = tx.objectStore(STORE_NAME).getAll();
                req.onsuccess = () => resolve(req.result);
            });
        },
        delete: async (id) => {
            const dbRef = await db.init();
            const tx = dbRef.transaction(STORE_NAME, 'readwrite');
            tx.objectStore(STORE_NAME).delete(id);
            return tx.complete;
        },
        clear: async () => {
            const dbRef = await db.init();
            const tx = dbRef.transaction(STORE_NAME, 'readwrite');
            tx.objectStore(STORE_NAME).clear();
            return tx.complete;
        }
    };

    // --- MAIN LOGIC ---
    let cropper = null;
    let currentPresetSize = 50;

    // Load History on Startup
    document.addEventListener('DOMContentLoaded', loadHistoryUI);

    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const url = URL.createObjectURL(file);
        document.getElementById('cropImage').src = url;
        
        // Switch Views
        document.getElementById('uploadStep').style.display = 'none';
        document.getElementById('cropStep').style.display = 'block';

        if (cropper) cropper.destroy();
        cropper = new Cropper(document.getElementById('cropImage'), {
            viewMode: 1,
            autoCropArea: 0.9,
            aspectRatio: 1 // Default
        });
        applyPreset('passport_in');
    }

    function applyPreset(val) {
        const sizes = { 'passport_in': 50, 'passport_us': 240, 'signature': 20, 'custom': 100 };
        const ratios = { 'passport_in': 1, 'passport_us': 1, 'signature': NaN, 'custom': NaN };
        
        currentPresetSize = sizes[val];
        if(cropper) cropper.setAspectRatio(ratios[val]);
    }

    async function confirmCrop() {
        const croppedCanvas = cropper.getCroppedCanvas({ maxWidth: 1500, maxHeight: 1500 });
        if (!croppedCanvas) return;

        // Compress
        document.getElementById('cropStep').style.display = 'none';
        document.getElementById('resultStep').style.display = 'block';
        
        const targetBytes = currentPresetSize * 1024;
        const resultBlob = await compressRecursive(croppedCanvas, targetBytes);

        // UI Update
        const url = URL.createObjectURL(resultBlob);
        document.getElementById('displayImage').src = url;
        const kbSize = (resultBlob.size / 1024).toFixed(1);
        document.getElementById('finalSizeBadge').innerText = `${kbSize} KB`;
        
        const dl = document.getElementById('downloadLink');
        dl.href = url;
        dl.download = `formfit_${Date.now()}.jpg`;

        // SAVE TO DB (Auto-Save)
        const record = {
            id: Date.now(),
            blob: resultBlob,
            name: `formfit_${Date.now()}.jpg`,
            size: kbSize + " KB",
            date: new Date().toLocaleString()
        };
        await db.save(record);
        
        // Refresh History List
        loadHistoryUI();
    }

    // --- HISTORY UI ---
    async function loadHistoryUI() {
        const items = await db.getAll();
        const list = document.getElementById('historyList');
        const clearBtn = document.getElementById('clearBtn');
        
        list.innerHTML = ''; // Clear current list
        
        if (items.length === 0) {
            list.innerHTML = '<p class="text-center text-muted small">No saved files yet.</p>';
            clearBtn.style.display = 'none';
            return;
        }

        clearBtn.style.display = 'block';
        
        // Sort newest first
        items.sort((a, b) => b.id - a.id).forEach(item => {
            const url = URL.createObjectURL(item.blob);
            
            const div = document.createElement('div');
            div.className = 'history-item';
            div.innerHTML = `
                <img src="${url}" class="history-thumb">
                <div class="history-meta">
                    <div class="fw-bold text-dark">${item.size}</div>
                    <div class="text-muted" style="font-size:0.8em">${item.date}</div>
                </div>
                <a href="${url}" download="${item.name}" class="btn btn-sm btn-outline-primary">‚¨áÔ∏è</a>
                <button onclick="deleteItem(${item.id})" class="btn btn-sm btn-outline-danger">üóëÔ∏è</button>
            `;
            list.appendChild(div);
        });
    }

    async function deleteItem(id) {
        if(confirm('Delete this file from history?')) {
            await db.delete(id);
            loadHistoryUI();
        }
    }
    
    async function clearHistory() {
        if(confirm('Clear all local history? This cannot be undone.')) {
            await db.clear();
            loadHistoryUI();
        }
    }

    // --- COMPRESSION ENGINE (Standard) ---
    async function compressRecursive(canvas, targetSize) {
        let min = 0.0, max = 1.0, bestBlob = null;
        for (let i = 0; i < 7; i++) {
            const mid = (min + max) / 2;
            const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', mid));
            if (blob.size <= targetSize) { bestBlob = blob; min = mid; }
            else { max = mid; }
        }
        if (bestBlob || canvas.width < 400) return bestBlob;
        
        const newCanvas = document.createElement('canvas');
        newCanvas.width = canvas.width * 0.8;
        newCanvas.height = canvas.height * 0.8;
        newCanvas.getContext('2d').drawImage(canvas, 0, 0, newCanvas.width, newCanvas.height);
        return await compressRecursive(newCanvas, targetSize);
    }
    
    function resetApp() { location.reload(); }
</script>

</body>
</html>
